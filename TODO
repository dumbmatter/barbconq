# Major current tasks

Combat
  combat complexity
    http://www.civfanatics.com/civ4/strategy/combat_explained.php
    http://home.comcast.net/~proc/civ4/combat_calc.htm
    BEST: http://apolyton.net/showthread.php/140622-The-Civ-IV-Combat-System
    first strikes
      archer gets 1 by default
    retreat/withdraw
      apply as a bonus, default 0
    collateral damage
    experience points

unit promotions
  Units.promotions - contains metadata
  onHoverTile bonuses for first unit
    how to define unit order? same as tile icon display
      should change depending on activeUnit
        like Combat.findBestDefender
        if no activeUnit, should be best defender against a "generic" unit, without bonuses for unit type but with other bonuses
      abstract into some general function that orders a list of units by strength
        like Combat.findBestDefender, but return sorted list of defenders
  icons for the promotions a unit has
    show in hover-box and bottom-info
    can they be text?
  group should get/set available promotions, but not current promotions
    wrap around Unit.availablePromotions for Group.availablePromotions
  confirm
    unit is healed halfway on promotion
    unit is unfortified when promoted
    make sure all unitBonuses are applied in battle
    battle odds match real game and http://home.comcast.net/~proc/civ4/combat_calc.htm
  remaining promotions for barbconq
    http://www.civfanatics.com/civ4/info/promotions/
    start with drill, continue alphabetical and pick relevant ones
  remaining promotions for after barbconq
    combat 4+
    lots of irrelevant ones

add highlighting of two units that are fighting, or maybe red dashed path in between?
  particularly important for when AI attacks

basic barb AI
  Game.moveUnits

rate of barb generation in non-visible tiles
  should increase with turns?

unit tests for grouped units?
  mock Controller, MapUI, ChromeUI?
  karma/mocha/chai
    karma/jasmine?
  install all with npm
    need karma-mocha and karma-chai?
  how to either organize code so index.html is not needed, or include index.html as fixture?
  source maps for karma output
    https://github.com/karma-runner/karma/issues/594
      need to run tsc in preprocessor?
      or https://github.com/demerzel3/karma-sourcemap-loader
        tried it, but doesn't seem to work
        problem seems to be in source-map package. works with version 0.1.32, but not 0.1.33
          https://github.com/mozilla/source-map/issues/106
          NO, problem is not source-map. it's the input to source-map: karma's reporter.js isn't getting column numbers. why? not sure. maybe it'll work if i can make it error-free until real tests run?

# Minor current tasks

UI lag caused by UNIT_MOVEMENT_UI_DELAY
  when moving a unit to explore fogged space, newly visible stuff should "pop" into view instantly
  lag on numpad movement

How to do instructions/new game for new users?
  new game on separate html page, instructions auto show on first game
  maybe instead of instructions showing, show a "mini-instructions" with a link to the full one

keyboard shortcuts
  enter: if not end of turn, cycle through units
    should allow you to let unit continue on path

"End turn early" green button and "end turn" red button, next to minimap
  if end turn early, make sure to move units on path towards targetCoords first!
    i have the same problem is i have a warrior/chariot group move towards target, have the "End" text flashing, separate so the chariot can still move, and then press enter
  is green/red always in sync with "begin next turn" blinker?
  add "shift+enter" shortcut for end turn early

right click to move
  right click on map -> drag off map -> drag back onto edge tile... path doesn't show up until drag onto another tile!
  by default, show "strongest" unit. but when right click hovering, show the strongest for defending against the impending attack

unit actions
  fortify
    defensive bonus
    healing
    top right indicator in unit icon
  sleep/fortify difference?
  are some of these universal? can move up to root Unit?

unit stacking UI options
  show highest strength one on top, and "+ X more" in text below it
  series of vertical lines at the bottom

unit health indicator on tile

tile improvements? maybe roads and forts

minify assets
  have a "make barbconq" that puts all the right options in a ready-to-go barbconq folder

modularize css better
  use one of those newfangled preprocessors?

get rid of mini-islands (unreachable tiles)
  in map generator, run pathfinder from each land tile to the center. if can't find, turn it to water.

UI POLISH
  show city name somewhere, both on map and on tile hover
  center minimap on its canvas when it is not the correct aspect ratio
  mapUI.goToCoords should be smooth
    draw a line between current coords and future coords. if it's long enough, discretize it and use setTimeout to move to each point along the way. uneven discretization can make it decelerate smoothly at the end
  Map.pathFinding will cancel if an enemy blocks the path... but not when the enemy blocks the last tile! in that case, it'll auto-attack
    should there be any auto-attack? even for unit right outside city the turn before, should it just generally wake up unit that is near enemy?
  when moving through units in Game.moveUnits, should always go through all the units on the current tile before moving on to other units
  When moving to a new tile, fog of war should dissipate immediately, not after delay
  currently, all click events pass through transparency. in civ4, it's only dragging when right click is held. allowing normal left and right clicks can lead to a lot of mis-clicks.
  limit number of entries that can be shown in hover-box
  CTRL and ALT messages in hover box should only be shown when applicable (>1 unit or >1 unit of a type)

# Barbarian Conquest (barbconq)

Mode with just your units, barbarian units, and one barbarian city

Goal: Find and capture the barbarian capital!
  
somewhere: "From the makers of Basketball GM, a free single-player basketball simulation game"

place barb city randomly
  this forces exploration, which presents a tradeoff: staying together increases your strength, but allows barbs to grow in numbers before you find their city.

core gameplay concept ideas
  barbarians continually spawn, with increasing rate. goal is to stay alive as long as possible
    this doesn't work, because user will just stack on forest hill
  better idea: capture barbarian city
    keep some barbs fortified there and spawn others too
    to prevent people from stacking on forest hill to gain XP before attacking, make the goal to minimize the number of turns

easy/medium/hard
  barb city on hill or not
  xp you start with
  number of barbs
  xp barbs start with
  intelligence of barbs (like.. likelihood to stack, or go to city)

end of game
  show stats
    won or lost
    turns
    time spent
    barbs killed, by unit type
    your units, with promotions and killed/not killed
    combine to a score, compare user against a famous conqueror (like civ4 does with leaders)
  have another game.result, "wonThenLost" for when all your units die after you've captured the city previously, and then show stats again

monetization ideas
  reddit: "Barbarian Conquest, a minigame built on a partial web-based port of Civ4"
  Make desktop and cordova versions
  GCS
  adsense panel on the side of the screen. put intro/manual content in HTML as divs to hide/show in game, for both SEO and adsense

# Nice to have

fog of war
  range should change depending on hills/forests/peaks in view or slightly out of view

Units.countMovementToCoords is getting really messy and has too much UI stuff there. need a better general concept of delays/movement/UI updating

pathfinding
  point towards water off screen, and it'll actually go there! need to cancel routes when it becomes clear target is not reachable
  doesn't correctly handle multi-unit tiles, since pathfinding algorithm doesn't know about the discreteness of turns (if you have 0.5 moves left, doesn't matter if you move onto grassland or hills)

should I make Units.Group.units and Tile.units lists of objects with ID keys, like game.units and game.groups?

Data
  keep it all in memory. write to indexeddb every turn

TypeScript
  Reevaluate all uses of "any"
  tsc --noImplicitAny

# Future

animate unit movement
  any built-in canvas animation support? like hinted at in http://www.sitepoint.com/html5-canvas-tutorial-introduction/ or maybe http://bdadam.com/blog/panning-and-scrolling-background-images-using-the-canvas-element.html
  maybe add a transparent canvas on top and use that to animate movement before redrawing map

scroll wheel zoom by increasing TILE_SIZE
  but this won't scale the contents of the tiles... so instead have some variable MapUI.scale which scales everything

# Far future

Friendly civs
  big problem: units of multiple civs can be on same tile.

Does cityDefense bonus apply for other civ's cities? Like a neutral city, or an ally's city?

Import civ4 maps

2d UI in HTML5
  read about how to do this, in general
  take inspiration from civ5 "strategic view"
  how to make it wrap at sides?
  libraries
    threejs?
      frustrum culling http://www.html5gamedevs.com/topic/930-best-practice-for-large-2d-world-in-threejs/
    pixi.js?
    IvanK?
      http://p.brm.sk/being/
    http://www.reddit.com/r/html5/comments/1zw8yl/canvas_newb_seeking_some_pointers_about_making_a/
    PROBABLY BEST:
      either threejs or raw webgl. try threejs first, looks easier

Allow lots of moddability, game modes
  look at what's in civ4